name: "Secret Scanning"

on:
  push:
    branches: [ "main", "master", "claude/**" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  gitleaks:
    name: Gitleaks Secret Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for all branches

    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}  # Only required for Gitleaks Enterprise

    - name: Upload Gitleaks report
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: gitleaks-report
        path: results.sarif
        retention-days: 30

  trufflehog:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: TruffleHog OSS
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
        extra_args: --debug --only-verified

    - name: Check for secrets
      if: failure()
      run: |
        echo "❌ Secrets detected! Please remove them before merging."
        exit 1

  custom-secret-patterns:
    name: Custom Secret Pattern Check
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for common secret patterns
      run: |
        echo "Scanning for common secret patterns..."

        # Define patterns to search for
        PATTERNS=(
          "HONEYCOMB_API_KEY.*=.*[a-zA-Z0-9]"
          "OPENAI_API_KEY.*=.*sk-"
          "ANTHROPIC_API_KEY.*=.*sk-ant-"
          "HF_TOKEN.*=.*hf_[a-zA-Z0-9]"
          "GITHUB_TOKEN.*=.*ghp_"
          "AWS_SECRET_ACCESS_KEY"
          "PRIVATE_KEY"
          "-----BEGIN.*PRIVATE KEY-----"
        )

        FOUND=0
        for pattern in "${PATTERNS[@]}"; do
          echo "Checking pattern: $pattern"
          if grep -r -E "$pattern" --exclude-dir=".git" --exclude-dir="node_modules" --exclude="*.yml" --exclude="*.yaml" .; then
            echo "⚠️  Found potential secret matching: $pattern"
            FOUND=$((FOUND + 1))
          fi
        done

        if [ $FOUND -gt 0 ]; then
          echo "❌ Found $FOUND potential secrets. Please review and remove."
          echo "Note: Exclude false positives in .gitleaksignore or use environment variables."
          exit 1
        else
          echo "✅ No secrets detected"
        fi
