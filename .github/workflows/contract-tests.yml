name: "API Contract Tests"

on:
  push:
    branches: [ "main", "master", "claude/**" ]
  pull_request:
    branches: [ "main", "master" ]

# Contract tests MUST pass before PR can be merged
# These tests define and enforce the builder API contract

jobs:
  contract-tests:
    name: Contract Tests (PR Blocker)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup pnpm
      uses: pnpm/action-setup@v3
      with:
        version: 8

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Build packages (required for contract tests)
      run: pnpm build

    - name: Run Builder Contract Tests
      run: |
        echo "Running API contract tests..."
        echo "These tests define the builder interface contract."
        echo "If they fail, the API contract has been broken."
        echo ""

        # Run contract tests specifically
        pnpm --filter @roma/builder test -- --run --reporter=verbose src/__tests__/contracts/

    - name: Generate contract test report
      if: always()
      run: |
        echo "Contract Test Summary" > contract-report.txt
        echo "=====================" >> contract-report.txt
        echo "" >> contract-report.txt
        echo "Test Suite: Builder API Contract" >> contract-report.txt
        echo "Purpose: Validate builder interface compliance" >> contract-report.txt
        echo "" >> contract-report.txt

        # This would contain actual test results in production
        pnpm --filter @roma/builder test -- --run --reporter=json src/__tests__/contracts/ > test-results.json || true

        echo "Test execution completed. Check artifacts for details." >> contract-report.txt

    - name: Upload contract test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: contract-test-results
        path: |
          contract-report.txt
          test-results.json
        retention-days: 30

    - name: Comment on PR with contract test results
      if: github.event_name == 'pull_request' && failure()
      uses: actions/github-script@v7
      with:
        script: |
          const message = `## ❌ API Contract Tests Failed

          The API contract tests have failed. This means your changes have broken the builder interface contract.

          **What this means:**
          - The builder API contract defines how components interact
          - Breaking changes require version bumps and migration guides
          - All contract tests MUST pass before merging

          **Next steps:**
          1. Review the contract test failures in the workflow logs
          2. Either fix your code to maintain the contract
          3. Or explicitly update the contract tests if this is an intentional breaking change

          **Contract tests enforce:**
          - Input/output schema validation
          - Method signatures
          - Error handling behavior
          - End-to-end pipeline integrity

          See workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          `;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });

    - name: Fail if contract tests failed
      if: failure()
      run: |
        echo "❌ API Contract Tests FAILED"
        echo ""
        echo "Contract tests define the builder interface contract."
        echo "These tests MUST pass before the PR can be merged."
        echo ""
        echo "Review the test failures above and either:"
        echo "  1. Fix your code to maintain the contract, OR"
        echo "  2. Update the contract tests if this is an intentional breaking change"
        echo ""
        exit 1

  schema-validation:
    name: Schema Validation Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup pnpm
      uses: pnpm/action-setup@v3
      with:
        version: 8

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Build schemas package
      run: pnpm --filter @roma/schemas build

    - name: Validate schema exports
      run: |
        echo "Validating schema exports..."

        node -e "
        const schemas = require('./packages/schemas/dist/index.js');

        const requiredSchemas = [
          'IntakeSchema',
          'ArchitectureSchema',
          'FeatureGraphSchema',
          'ScaffoldingSpecSchema',
          'generateOpenAPISpec',
          'exportOpenAPISpec'
        ];

        const missing = requiredSchemas.filter(name => !schemas[name]);

        if (missing.length > 0) {
          console.error('❌ Missing required schema exports:', missing);
          process.exit(1);
        }

        console.log('✅ All required schemas exported correctly');
        "

    - name: Generate OpenAPI spec
      run: |
        echo "Generating OpenAPI specification..."

        node -e "
        const { exportOpenAPISpec } = require('./packages/schemas/dist/index.js');
        const fs = require('fs');

        try {
          const spec = exportOpenAPISpec();
          fs.writeFileSync('openapi.json', spec);
          console.log('✅ OpenAPI spec generated successfully');

          // Validate it's valid JSON
          const parsed = JSON.parse(spec);
          console.log('✅ OpenAPI spec is valid JSON');
          console.log('  Paths:', Object.keys(parsed.paths).length);
          console.log('  Schemas:', Object.keys(parsed.components.schemas).length);
        } catch (error) {
          console.error('❌ Failed to generate OpenAPI spec:', error.message);
          process.exit(1);
        }
        "

    - name: Upload OpenAPI spec
      uses: actions/upload-artifact@v4
      with:
        name: openapi-specification
        path: openapi.json
        retention-days: 30

    - name: Run schema tests
      run: |
        echo "Running schema validation tests..."
        pnpm --filter @roma/schemas test -- --run

  contract-gate:
    name: Contract Gate (All Contract Tests Must Pass)
    runs-on: ubuntu-latest
    needs: [contract-tests, schema-validation]
    if: always()

    steps:
    - name: Check contract test results
      run: |
        CONTRACT_RESULT="${{ needs.contract-tests.result }}"
        SCHEMA_RESULT="${{ needs.schema-validation.result }}"

        echo "Contract Tests: $CONTRACT_RESULT"
        echo "Schema Validation: $SCHEMA_RESULT"

        if [[ "$CONTRACT_RESULT" != "success" ]] || [[ "$SCHEMA_RESULT" != "success" ]]; then
          echo ""
          echo "❌ Contract tests failed. PR CANNOT be merged."
          echo ""
          echo "Contract tests ensure:"
          echo "  - Builder interfaces work as expected"
          echo "  - Schemas are valid and consistent"
          echo "  - No breaking changes without version bumps"
          echo ""
          exit 1
        fi

        echo "✅ All contract tests passed! API contract is satisfied."
